# QMCH SYSTEM ARCHITECTURE & DATABASE DESIGN

## Architecture Overview

```
???????????????????????????????????????????????????????????????????
?                     PRESENTATION LAYER                           ?
?                    (Blazor Components)                            ?
?  Home.razor | Calendar.razor | Analytics.razor | Forms | Lists   ?
???????????????????????????????????????????????????????????????????
                               ?
???????????????????????????????????????????????????????????????????
?                    SERVICE LAYER                                 ?
?  ???????????????????????????????????????????????????????????    ?
?  ? Core Services:                                          ?    ?
?  ? • IPatientService         • IStaffService              ?    ?
?  ? • IVisitService           • IUserService               ?    ?
?  ???????????????????????????????????????????????????????????    ?
?                                                                   ?
?  ???????????????????????????????????????????????????????????    ?
?  ? Advanced Services:                                      ?    ?
?  ? • IInsuranceService       • IClaimService              ?    ?
?  ? • IScheduleManagementService • ITimeAttendanceService  ?    ?
?  ? • ITimeOffRequestService  • ILicenseService            ?    ?
?  ? • IComplianceService      • ICarePlanService           ?    ?
?  ? • IAssessmentService      • IReportingService          ?    ?
?  ? • ICommunicationService   • IDocumentService           ?    ?
?  ? • IAuditService                                         ?    ?
?  ???????????????????????????????????????????????????????????    ?
???????????????????????????????????????????????????????????????????
                               ?
???????????????????????????????????????????????????????????????????
?                   REPOSITORY LAYER                               ?
?  ????????????????????????????????????????????????????????????   ?
?  ? Generic Repository: IGenericRepository<T>               ?   ?
?  ? • CRUD Operations  • Async Methods                      ?   ?
?  ? • Query Filtering  • Pagination                         ?   ?
?  ????????????????????????????????????????????????????????????   ?
?                                                                   ?
?  ????????????????????????????????????????????????????????????   ?
?  ? Specialized Repositories:                               ?   ?
?  ? • IPatientRepository          • IStaffRepository        ?   ?
?  ? • IVisitRepository            • IInsuranceRepository    ?   ?
?  ? • IClaimRepository            • IScheduleRepository     ?   ?
?  ? • ITimeAttendanceRepository   • ILicenseRepository      ?   ?
?  ? • IComplianceRepository       • ICarePlanRepository     ?   ?
?  ? • And 5+ more...                                        ?   ?
?  ????????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????????
                               ?
???????????????????????????????????????????????????????????????????
?                    DATA ACCESS LAYER                             ?
?  ApplicationDbContext (Entity Framework Core)                    ?
?  • 25+ DbSets                 • Relationship Configurations      ?
?  • Fluent API Configuration   • Migration Support               ?
???????????????????????????????????????????????????????????????????
                               ?
???????????????????????????????????????????????????????????????????
?                    DATABASE LAYER                                ?
?                       SQL Server                                 ?
?  • Patient Tables     • Staff Tables      • Schedule Tables      ?
?  • Visit Tables       • Insurance/Billing • Compliance Tables    ?
?  • Communication      • Document Storage  • Audit Logs           ?
???????????????????????????????????????????????????????????????????
```

---

## Database Entity Relationship Diagram

```
????????????????????????
?       Users          ? (ASP.NET Core Identity)
? (AspNetUsers)        ?
????????????????????????
? Id (PK)              ?
? Username             ?
? Email                ?
? PasswordHash         ?
? RoleId (FK)          ?
????????????????????????
               ?
     ?????????????????????
     ?                   ?
     ?                   ?
????????????????????  ????????????????????
?    Patient       ?  ?      Staff       ?
????????????????????  ????????????????????
? Id (PK)          ?  ? Id (PK)          ?
? FirstName        ?  ? FirstName        ?
? LastName         ?  ? LastName         ?
? DateOfBirth      ?  ? DateOfBirth      ?
? SSN (encrypted)  ?  ? Email            ?
? Address          ?  ? Phone            ?
? Status           ?  ? Role             ?
? AdmissionDate    ?  ? HireDate         ?
? CreatedBy (FK)   ?  ? Department       ?
? UpdatedBy (FK)   ?  ? CreatedBy (FK)   ?
????????????????????  ????????????????????
          ?                    ?
    ?????????????????????     ????????????????????????
    ?            ?      ?     ?          ?           ?
    ?            ?      ?     ?          ?           ?
???????????  ?????????? ?  ??????????? ?????????? ???????????
? Visit   ?  ? Care   ? ?  ? Staff   ? ?License ? ? Schedule?
?         ?  ? Plan   ? ?  ? Skill   ? ?        ? ?         ?
???????????  ?????????? ?  ??????????? ?????????? ???????????
?PatientId????PatientId ?  ?StaffId  ? ?StaffId ? ?StaffId  ?
?StaffId  ?  ?CreatedBy   ?  ?SkillId  ? ?License ? ?Date     ?
?SchedDate?  ?Goals       ?  ?Level    ? ?Number  ? ?ShiftStart
?Status   ?  ?Interventns ?  ?Cert Date? ?Expiry  ? ?ShiftEnd ?
???????????  ????????????? ?  ??????????? ?????????? ???????????
     ?            ?         ?
     ?            ?         ?
     ?      ?????????????????
     ?      ? Care Plan    ??
     ?      ? Intervention ??
     ?      ?????????????????
     ?      ? CarePlanId   ??
     ?      ? Intervention ??
     ?      ? Frequency    ??
     ?      ? Status       ??
     ?      ?????????????????
     ?                      ?
     ?                      ?
????????????????????  ????????????????????
? Visit Documen-   ?  ? Patient Assess   ?
? tation           ?  ?                  ?
????????????????????  ????????????????????
? VisitId (FK)     ?  ? PatientId (FK)   ?
? NoteType         ?  ? Assessment Type  ?
? Content          ?  ? Physical Exam    ?
? VitalSigns (JSON)?  ? Mental Status    ?
? Medications      ?  ? Functional Status?
? Services         ?  ? Safety Risks     ?
? Signature        ?  ? Recommendations  ?
? CreatedAt        ?  ? Status           ?
????????????????????  ????????????????????
         ?
    ?????????????????????
    ?                   ?
    ?                   ?
????????????????????  ????????????????????
? Insurance        ?  ? Medication       ?
????????????????????  ????????????????????
? PatientId (FK)   ?  ? PatientId (FK)   ?
? Provider         ?  ? Name             ?
? PolicyNumber     ?  ? Dosage           ?
? GroupNumber      ?  ? Frequency        ?
? EffectiveDate    ?  ? Route            ?
? ExpiryDate       ?  ? StartDate        ?
? IsPrimary        ?  ? EndDate          ?
? CreatedAt        ?  ? IsActive         ?
????????????????????  ????????????????????
         ?
         ?
    ????????????????????
    ? Claim            ?
    ????????????????????
    ? VisitId (FK)     ?
    ? InsuranceId (FK) ?
    ? ClaimNumber      ?
    ? AmountBilled     ?
    ? AmountPaid       ?
    ? Status (Pending) ?
    ? SubmittedAt      ?
    ? ProcessedAt      ?
    ????????????????????
```

---

## Database Tables (25+)

### Core Identity Tables
```sql
AspNetUsers          -- User accounts (ASP.NET Core Identity)
AspNetRoles          -- User roles
AspNetUserRoles      -- User-Role mapping
```

### Patient Module
```sql
Patients             -- Patient demographics
Medications          -- Patient medications
Insurance            -- Patient insurance policies
PatientAssessment    -- Clinical assessments (OASIS, Initial, etc.)
CarePlan             -- Care goals and interventions
CarePlanIntervention -- Individual interventions
```

### Staff Module
```sql
StaffMembers         -- Staff/Employee profiles
Skills               -- Available skills
StaffSkills          -- Staff-Skill mapping (Many-to-Many)
License              -- Professional licenses
Schedule             -- Staff shift schedules
TimeAttendance       -- Clock in/out records
TimeOffRequest       -- PTO/Leave requests
StaffCompliance      -- Compliance tracking
ComplianceRequirement -- Configurable requirements
```

### Visit Module
```sql
Visits               -- Visit scheduling and tracking
VisitDocumentation   -- Visit notes, vital signs, medications
```

### Communication & Documents
```sql
Message              -- Internal secure messaging
Notification         -- User notifications
DocumentRecord       -- File uploads and management
```

### Audit & Quality
```sql
AuditLog             -- Complete audit trail
QualityAssurance     -- Quality metrics
```

---

## Service Implementation Details

### InsuranceService
- GetByPatientIdAsync() - Retrieve patient's insurance policies
- GetPrimaryInsuranceAsync() - Get primary insurance for billing
- CreateAsync(), UpdateAsync(), DeleteAsync() - CRUD operations

### ClaimService
- GetByStatusAsync() - Filter claims by status (Pending, Paid, Denied)
- GetTotalRevenueAsync() - Calculate revenue from paid claims
- GetOutstandingClaimsAsync() - Calculate outstanding amount
- Automatic claim number generation

### ScheduleManagementService
- IsStaffAvailableAsync() - Conflict detection
- GetByStaffAndDateRangeAsync() - Retrieve schedule for date range
- Automatic schedule validation

### TimeAttendanceService
- ClockInAsync() - Record clock-in with location
- ClockOutAsync() - Record clock-out and calculate hours
- CalculateHoursWorkedAsync() - Generate timesheet data
- GPS tracking support

### ComplianceService
- GetExpiringAsync() - Alert on licenses expiring soon
- GetExpiredAsync() - Track expired credentials
- GetComplianceStatusByStaffAsync() - Staff compliance dashboard

### ReportingService
- GetDailyCensusAsync() - Active patient count
- GetStaffProductivityAsync() - Visit count per staff
- GetVisitCompletionRateAsync() - Performance metrics
- GetRevenueReportAsync() - Financial analysis
- GetLicenseExpiryReportAsync() - Compliance reporting

### CommunicationService
- Inbox/Sent message management
- Priority-based messaging
- Read receipts and notifications

---

## Data Validation & Constraints

### Entity-Level Validation
```csharp
// Example: Patient entity
[Required] public string FirstName { get; set; }
[StringLength(20)] public string? Phone { get; set; }
[Range(0, 120)] public int Age { get; set; }

// Example: Visit entity
[Required] public DateTime ScheduledStartTime { get; set; }
public DateTime? ActualStartTime { get; set; }
// Validation: ActualStartTime > ScheduledStartTime
```

### Relationship Integrity
- Foreign Key Constraints
- Cascade Delete for dependent entities
- Set Null for optional relationships

### Database Constraints
- Primary Keys on all entities
- Unique indexes on identifiers (SSN, PolicyNumber, etc.)
- Default values for status fields
- Timestamp fields (CreatedAt, UpdatedAt)

---

## Sample Queries

### Get Patient with All Related Data
```csharp
var patient = await _context.Patients
    .Include(p => p.Visits)
        .ThenInclude(v => v.Staff)
    .Include(p => p.Insurances)
    .Include(p => p.Medications)
    .Include(p => p.Assessments)
    .FirstOrDefaultAsync(p => p.Id == id);
```

### Get Staff Availability for Scheduling
```csharp
var availableStaff = await _context.StaffMembers
    .Where(s => s.Status == "Active" && s.IsAvailable)
    .Include(s => s.StaffSkills)
        .ThenInclude(ss => ss.Skill)
    .Include(s => s.Schedules)
    .Where(s => !s.Schedules.Any(sch => 
        sch.ShiftStartTime < requestedEndTime && 
        sch.ShiftEndTime > requestedStartTime))
    .ToListAsync();
```

### Get Outstanding Claims
```csharp
var outstanding = await _context.Claims
    .Where(c => c.Status == "Pending")
    .Include(c => c.Visit)
        .ThenInclude(v => v.Patient)
    .GroupBy(c => c.Visit.PatientId)
    .Select(g => new {
        PatientId = g.Key,
        TotalAmount = g.Sum(c => c.AmountBilled),
        ClaimCount = g.Count()
    })
    .ToListAsync();
```

---

## Performance Optimization

### Database Level
- Indexes on frequently queried columns (PatientId, StaffId, Status)
- Asynchronous queries throughout
- No N+1 query problems (eager loading)

### Application Level
- Repository pattern for data access
- Service layer for business logic
- Dependency injection for loose coupling
- Async/await for all I/O operations

### Caching Strategy (Phase 2)
- Role/Permission caching
- Skill lookup caching
- Report data caching

---

## Security Implementation

### Authentication
- ASP.NET Core Identity
- Password hashing (PBKDF2)
- Email verification

### Authorization
- Role-based access control
- Claim-based policies
- Resource-level authorization

### Data Protection
- SQL injection prevention (EF Core parameterized queries)
- XSS protection (Blazor built-in)
- CSRF protection (ASP.NET Core middleware)

### Audit Trail
- Complete logging of user actions
- Entity change tracking
- Timestamp recording

---

## Migration Strategy

### Creating New Migrations
```powershell
dotnet ef migrations add FeatureName
dotnet ef database update
```

### Deployment Process
1. Create migration locally
2. Test on development database
3. Review migration script
4. Deploy to staging
5. Run migrations
6. Verify data integrity
7. Deploy to production

---

## Scalability Considerations

### Horizontal Scaling
- Stateless service design
- Database connection pooling
- Load balancer support

### Vertical Scaling
- Async operations throughout
- Connection caching
- Query optimization

### Future Enhancements
- Caching layer (Redis)
- Message queue (RabbitMQ)
- Search engine (Elasticsearch)
- Logging aggregation (ELK Stack)

---

## Maintenance & Monitoring

### Database Maintenance
- Regular backup strategy
- Index fragmentation analysis
- Query performance monitoring

### Application Monitoring
- Error logging
- Performance metrics
- User activity tracking
- Audit log analysis

---

*End of Architecture Document*
