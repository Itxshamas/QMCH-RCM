@page "/dashboard/analytic/view"
@using QMCH.Components.Pages
@inherits AnalyticsBase

<PageTitle>Analytics - QHMC</PageTitle>

<div class="analytics-container">
    <div class="breadcrumb"><a href="/">Dashboard</a> / <a href="/dashboard/analytic/view">Analytics</a> / Overview</div>
    <div class="section-sep"></div>

    <!-- WORKFORCE SUMMARY SECTION -->
    <div class="analytics-card workforce-card">
        <!-- KPI Row -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-value">@TotalStaff</div>
                <div class="kpi-label">Total Staff</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">@AveragePresencePercent.ToString("0.0")% </div>
                <div class="kpi-label">Avg Presence</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">@TotalAbsent</div>
                <div class="kpi-label">Total Absent (month)</div>
            </div>
            <div class="kpi-actions">
                <button class="btn-green" @onclick="ExportCsv">Export CSV</button>
                <button class="icon-btn" title="Toggle Gridlines" @onclick="() => ToggleGridlines()"><i class="fa fa-th-large"></i></button>
            </div>
        </div>

        <!-- Header -->
        <div class="workforce-header">

            <!-- Left Controls -->
            <div class="header-controls">
                <button class="icon-btn" @onclick="GoToPreviousMonth">
                    <i class="fa fa-chevron-left"></i>
                </button>
                <button class="icon-btn" @onclick="GoToNextMonth">
                    <i class="fa fa-chevron-right"></i>
                </button>
                <button class="today-btn" @onclick="GoToToday">Today</button>
            </div>

            <!-- Title -->
            <div class="workforce-title">
                Workforce Summary - @CurrentMonthYearDisplay
            </div>

            <!-- Right Controls -->
            <div class="header-controls">
                <label style="margin-right:8px;">Chart</label>
                <select @bind="SelectedChartType" class="form-control" style="width:140px; margin-right:8px;">
                    <option>Line</option>
                    <option>Bar</option>
                    <option>Area</option>
                </select>
                <button class="icon-btn" @onclick="() => ToggleWeekends()" title="Toggle Weekends">W</button>
            </div>

        </div>

    @if (showDayDetail)
    {
        <div class="day-detail-backdrop" @onclick="CloseDayDetail">
            <div class="day-detail-box" @onclick:stopPropagation="true">
                <h4>Details for @detailDay.ToString("dd MMM yyyy")</h4>
                <div class="day-detail-list">
                    @foreach (var r in dayDetails)
                    {
                        <div class="day-detail-row">
                            <div>@r.Staff</div>
                            <div>@r.Status</div>
                            <div>@r.Time</div>
                        </div>
                    }
                </div>
                <div style="text-align:right; margin-top:12px;"><button class="btn-green" @onclick="CloseDayDetail">Close</button></div>
            </div>
        </div>
    }

        <!-- Chart + Dates Wrapper -->
        <div class="workforce-chart-wrapper">

            <!-- Chart Area -->
            <div class="workforce-chart">
                @* Simple interactive SVG chart (mock data) *@
                @{
                    var colWidth = 60; // px - match CSS
                    var svgWidth = Math.Max(600, DaysInCurrentMonth * colWidth);
                }
                <div style="width:100%; overflow:auto;">
                    <svg viewBox="0 0 @svgWidth 320" preserveAspectRatio="xMidYMid meet" style="width:@(svgWidth)px; height:320px;">
                        @for (int d = 1; d <= DaysInCurrentMonth; d++)
                        {
                            var day = new DateTime(CurrentDate.Year, CurrentDate.Month, d);
                            var pct = GetDayPresencePercent(day);
                            var h = (pct / 100.0) * 260.0;
                            var x = (d - 1) * colWidth + 8; // small padding
                            var width = colWidth - 16;
                            var y = 300 - h;
                            var isWeekend = day.DayOfWeek == DayOfWeek.Saturday || day.DayOfWeek == DayOfWeek.Sunday;
                            var cls = (isWeekend && !ShowWeekends) ? "bar-dim" : "bar";
                            <rect class="@cls" x="@x" y="@y" width="@width" height="@h" @onclick="() => DayClicked(day)" style="cursor:pointer;">
                                <title>@(day.ToString("dd MMM yyyy") + ": " + pct.ToString("0.0") + "% present")</title>
                            </rect>
                        }
                    </svg>
                </div>
            </div>

            <!-- Bottom Dates -->
            <div class="workforce-x-axis">
                @for (int day = 1; day <= DaysInCurrentMonth; day++)
                {
                    <span>@day.ToString("00")-@CurrentDate.ToString("MMM")-@CurrentDate.Year</span>
                }
            </div>

        </div>

    </div>


    <!-- SECTION 2 : CLIENT VISIT SUMMARY -->
    <div class="analytics-card">
        <div class="premium-header">
            <div>
                <h3>Client Visit Summary - Planning</h3>
                <div class="premium-sub">Monthly planning data with trends and growth</div>
            </div>
            <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
                <div class="kpi-badge">↑ 12% vs last month</div>
                <select class="form-control" style="width:140px;">
                    <option>February 2026</option>
                    <option>January 2026</option>
                </select>
            </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <div class="kpi-card">
                <div class="kpi-value">3,420</div>
                <div class="kpi-label">Total Visits (Plan)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">122</div>
                <div class="kpi-label">Avg Per Day</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">+8.4%</div>
                <div class="kpi-label">Growth</div>
            </div>
        </div>

        <div class="card-body" style="margin-top:12px;">
            <div class="chart-placeholder">Premium line chart with gradient and tooltips (integrate chart library)</div>
        </div>
    </div>


    <!-- SECTION 3 : FINANCIAL (PLANNING DATA) -->
    <div class="analytics-card split-row">
        <div>
            <div class="card-header"><h3>Financial Client Visit Graph - Planning Data</h3></div>
            <div class="card-body"><div class="chart-placeholder">Curved line graph with gradient fill and animated draw (Chart lib)</div></div>
        </div>
        <div class="summary-panel">
            <div class="metric-row"><div class="label">Total Plan</div><div class="value">3,420</div></div>
            <div class="metric-row"><div class="label">Avg / Day</div><div class="value">122</div></div>
            <div class="metric-row"><div class="label">Growth</div><div class="value">+8.4%</div></div>
            <div style="margin-top:12px; text-align:center;"><div style="width:120px; height:120px; margin:0 auto;" class="donut-placeholder">68%</div></div>
        </div>
    </div>

    <!-- SECTION 4 : FINANCIAL (ACTUAL DATA) -->
    <div class="analytics-card split-row" style="margin-top:12px;">
        <div>
            <div class="card-header"><h3>Financial Client Visit Graph - Actual Data</h3></div>
            <div class="card-body"><div class="chart-placeholder">Combined Bar + Line Chart (Actual vs Target)</div></div>
        </div>
        <div class="summary-panel">
            <div class="metric-row"><div class="label">Total Actual Visits</div><div class="value">2,980</div></div>
            <div class="metric-row"><div class="label">Target Visits</div><div class="value">3,400</div></div>
            <div class="metric-row"><div class="label">Achievement</div><div class="value">87.6%</div></div>
            <div style="margin-top:12px; text-align:center;"><div style="width:120px; height:120px; margin:0 auto;" class="donut-placeholder">88%</div></div>
        </div>
    </div>


    <!-- SECTION 5 : ATTENDANCE SUMMARY -->
    <div class="analytics-card attendance-card">
        <div class="card-header">
            <div>
                <h3>Attendance Summary - February 2026</h3>
                <div class="premium-sub">Overview of attendance metrics and trends</div>
            </div>
            <div style="margin-left:auto;"><button class="btn-green">Download Report</button></div>
        </div>

        <div style="margin-top:12px;">
            <div class="att-metrics">
                <div class="att-card att-present glass">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:22px; font-weight:800;">1,120</div>
                            <div style="font-size:12px;">Present</div>
                        </div>
                        <div class="att-icon" style="background:rgba(255,255,255,0.12);">🙂</div>
                    </div>
                    <div class="att-progress"><i style="width:72%"></i></div>
                </div>

                <div class="att-card att-absent glass">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:22px; font-weight:800;">80</div>
                            <div style="font-size:12px;">Absent</div>
                        </div>
                        <div class="att-icon" style="background:rgba(255,255,255,0.12);">☹️</div>
                    </div>
                    <div class="att-progress"><i style="width:8%"></i></div>
                </div>

                <div class="att-card att-late glass">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:22px; font-weight:800;">45</div>
                            <div style="font-size:12px;">Late</div>
                        </div>
                        <div class="att-icon" style="background:rgba(255,255,255,0.12);">⏰</div>
                    </div>
                    <div class="att-progress"><i style="width:5%"></i></div>
                </div>

                <div class="att-card att-leave glass">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:22px; font-weight:800;">30</div>
                            <div style="font-size:12px;">On Leave</div>
                        </div>
                        <div class="att-icon" style="background:rgba(255,255,255,0.12);">🏖️</div>
                    </div>
                    <div class="att-progress"><i style="width:4%"></i></div>
                </div>
            </div>

            <div style="display:flex; gap:18px; margin-top:16px; align-items:center;">
                <div class="donut-placeholder">Distribution</div>
                <div>
                    <div style="font-size:18px; font-weight:700;">Attendance Rate</div>
                    <div style="font-size:28px; font-weight:800; color:#16A34A;">92.4%</div>
                    <div style="margin-top:8px; color:#6b7280;">Status: <strong>Good</strong></div>
                </div>
            </div>
        </div>
    </div>


    <!-- SECTION 6 : BOTTOM ROW - Biometric & Client Visit Summary -->
    <div class="bottom-cards-row">

        <!-- Biometric Registration Card -->
        <div class="analytics-card biometric-card">

            <div class="card-header">
                <span class="section-title">Pending Biometric Registration</span>
            </div>

            <div class="biometric-list">

                <div class="biometric-item">
                    <span class="name">John Smith</span>
                    <span class="status-pending">Pending</span>
                </div>

                <div class="biometric-item">
                    <span class="name">Mary Johnson</span>
                    <span class="status-pending">Pending</span>
                </div>

                <div class="biometric-item">
                    <span class="name">David Lee</span>
                    <span class="status-pending">Pending</span>
                </div>

            </div>

        </div>

        <!-- Client Visit Summary Card -->
        <div class="analytics-card visit-card">

            <div class="card-header">
                <span class="section-title">Client Visit Summary</span>
            </div>

            <div class="visit-summary">

                <div class="visit-box visit-planned">
                    <span class="visit-count">120</span>
                    <span class="visit-label">Planned</span>
                </div>

                <div class="visit-box visit-completed">
                    <span class="visit-count">98</span>
                    <span class="visit-label">Completed</span>
                </div>

                <div class="visit-box visit-pending">
                    <span class="visit-count">22</span>
                    <span class="visit-label">Pending</span>
                </div>

            </div>

        </div>

    </div>

</div>
