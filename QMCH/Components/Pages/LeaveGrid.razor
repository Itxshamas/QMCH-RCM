@page "/leave/grid/list"
@inject ILeaveService LeaveService
@rendermode InteractiveServer

<PageTitle>Leave Summary - Quality Homecare System</PageTitle>

<div class="leave-grid-container">
    <!-- Header with buttons -->
    <div class="leave-grid-header">
        <div class="header-buttons">
            <button class="btn btn-new" @onclick="() => OpenNewLeaveModal()">
                <i class="fa fa-plus"></i> New
            </button>
            <button class="btn btn-fullday" @onclick="() => OpenFullDayOffModal()">
                <i class="fa fa-calendar"></i> FullDay OFF
            </button>
        </div>
        <div class="header-filters">
            <button class="btn btn-filter" @onclick="() => showFilterPanel = !showFilterPanel">
                <i class="fa fa-filter"></i> Filter/Reason
            </button>
            <button class="btn btn-clear" @onclick="ClearFilters">
                <i class="fa fa-times"></i> Clear Filters
            </button>
        </div>
    </div>

    <!-- Filter Panel -->
    @if (showFilterPanel)
    {
        <div class="filter-panel">
            <div class="filter-row">
                <div class="filter-group">
                    <label>By Employee</label>
                    <select class="form-control" @bind="filterEmployee">
                        <option value="">--All--</option>
                        @foreach (var emp in employees)
                        {
                            <option value="@emp">@emp</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label>By Leave Type</label>
                    <select class="form-control" @bind="filterLeaveType">
                        <option value="">--All--</option>
                        <option value="Day Off">Day Off</option>
                        <option value="Annual">Annual</option>
                        <option value="Sick">Sick</option>
                        <option value="Personal">Personal</option>
                        <option value="Maternity">Maternity</option>
                        <option value="Paternity">Paternity</option>
                        <option value="Bereavement">Bereavement</option>
                        <option value="Unpaid">Unpaid</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>By Status</label>
                    <select class="form-control" @bind="filterStatus">
                        <option value="">--All--</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group date-range">
                    <label>Start Date</label>
                    <input type="date" class="form-control" @bind="filterStartDate" />
                </div>
                <div class="filter-group date-range">
                    <label>End Date</label>
                    <input type="date" class="form-control" @bind="filterEndDate" />
                </div>
            </div>
            <div class="filter-actions">
                <input type="text" class="search-input" placeholder="Search..." @bind="searchTerm" @bind:event="oninput" @onkeyup="ApplyFilters" />
            </div>
        </div>
    }

    <!-- Data Table -->
    <div class="leave-grid-table">
        @if (isLoading)
        {
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        }
        else if (!filteredItems.Any())
        {
            <div class="empty-state">
                <p>No leave records found</p>
            </div>
        }
        else
        {
            <table class="leave-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" /></th>
                        <th>Employee</th>
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Remarks</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in paginatedItems)
                    {
                        <tr>
                            <td><input type="checkbox" /></td>
                            <td class="employee-cell">@item.EmployeeName</td>
                            <td>@item.LeaveType</td>
                            <td>@item.StartDate.ToString("yyyy-MM-dd")</td>
                            <td>@item.EndDate.ToString("yyyy-MM-dd")</td>
                            <td>@item.Reason</td>
                            <td>
                                <div class="status-actions">
                                    <span class="status-badge @GetStatusClass(item.Status)">@item.Status</span>
                                    <div class="action-buttons">
                                        @if (item.Status == "Pending")
                                        {
                                            <button class="action-btn approve" title="Approve" @onclick="() => ApproveLeave(item.Id)">
                                                <i class="fa fa-check"></i>
                                            </button>
                                            <button class="action-btn reject" title="Reject" @onclick="() => ShowRejectModal(item.Id)">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        }
                                        <button class="action-btn edit" title="Edit" @onclick="() => EditLeave(item)">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete" title="Delete" @onclick="() => Delete(item.Id)">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination-footer">
                <div class="pagination-info">
                    Showing 1 to @paginatedItems.Count() of @filteredItems.Count() entries
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" @onclick="PreviousPage" disabled="@(currentPage <= 1)">Previous</button>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNum = i;
                        <button class="page-btn @(currentPage == pageNum ? "active" : "")" @onclick="() => GoToPage(pageNum)">@i</button>
                    }
                    <button class="page-btn" @onclick="NextPage" disabled="@(currentPage >= totalPages)">Next</button>
                </div>
            </div>
        }
    </div>
</div>

<!-- New Leave Modal -->
<ModalDialog @bind-IsVisible="showNewLeaveModal" Title="Add Nurse Leave" Size="lg" CloseOnOverlay="false">
    <EditForm Model="newLeaveForm" OnValidSubmit="SaveNewLeave">
        <DataAnnotationsValidator />
        <div class="modal-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Employee <span class="required">*</span></label>
                    <select class="form-control" @bind="newLeaveForm.EmployeeName">
                        <option value="">--Select--</option>
                        @foreach (var emp in employees)
                        {
                            <option value="@emp">@emp</option>
                        }
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="form-control" @bind="newLeaveForm.StartDate" />
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" class="form-control" @bind="newLeaveForm.EndDate" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Leave Type <span class="required">*</span></label>
                    <select class="form-control" @bind="newLeaveForm.LeaveType">
                        <option value="">--Select--</option>
                        <option value="Day Off">Day Off</option>
                        <option value="Annual">Annual</option>
                        <option value="Sick">Sick</option>
                        <option value="Personal">Personal</option>
                        <option value="Maternity">Maternity</option>
                        <option value="Paternity">Paternity</option>
                        <option value="Bereavement">Bereavement</option>
                        <option value="Unpaid">Unpaid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Leave Status</label>
                    <select class="form-control" @bind="newLeaveForm.Status">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Remark</label>
                <textarea class="form-control" rows="3" @bind="newLeaveForm.Reason"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-save">Save</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseNewLeaveModal">Cancel</button>
        </div>
    </EditForm>
</ModalDialog>

<!-- Full Day OFF Modal -->
<ModalDialog @bind-IsVisible="showFullDayOffModal" Title="FullDay OFF" Size="lg" CloseOnOverlay="false">
    <div class="fullday-modal">
        <p class="info-text">
            The field can be used to give Full OFF for Nurses, that means The Nurse cannot be Scheduled to any Client on the Day(s) you, and Scheduled that are already Booked will be Highlighted on Day OFF to Timesheets.
        </p>
        
        <div class="fullday-form">
            <div class="form-group">
                <label>By Employee</label>
                <select class="form-control" @bind="fullDayForm.EmployeeName">
                    <option value="">--Select--</option>
                    @foreach (var emp in employees)
                    {
                        <option value="@emp">@emp</option>
                    }
                </select>
            </div>

            <div class="days-selector">
                <label>Days</label>
                <div class="days-checkboxes">
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[0]" /> Sun
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[1]" /> Mon
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[2]" /> Tue
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[3]" /> Wed
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[4]" /> Thu
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[5]" /> Fri
                    </label>
                    <label class="day-checkbox">
                        <input type="checkbox" @bind="selectedDays[6]" /> Sat
                    </label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="form-control" @bind="fullDayForm.StartDate" />
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" class="form-control" @bind="fullDayForm.EndDate" />
                </div>
            </div>

            <div class="form-group">
                <label>Odd Days <input type="checkbox" @bind="fullDayForm.OddDaysOnly" class="odd-days-checkbox" /></label>
            </div>

            <div class="form-group">
                <label>Even Days <input type="checkbox" @bind="fullDayForm.EvenDaysOnly" class="even-days-checkbox" /></label>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-update" @onclick="SaveFullDayOff">Calculate Dates/Times</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseFullDayOffModal">Cancel</button>
        </div>
    </div>
</ModalDialog>

<!-- Reject Modal -->
<ModalDialog @bind-IsVisible="showRejectModal" Title="Reject Leave Request" Size="lg" CloseOnOverlay="false">
    <div class="reject-form">
        <div class="form-group">
            <label>Rejection Reason</label>
            <textarea class="form-control" rows="4" @bind="rejectionReason" placeholder="Enter reason for rejection"></textarea>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" @onclick="ConfirmReject">Reject</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseRejectModal">Cancel</button>
        </div>
    </div>
</ModalDialog>
