@page "/attendance/list"
@inject IEmployeeService EmployeeService
@rendermode InteractiveServer

<PageTitle>Attendance - QHMCPro</PageTitle>

<div class="page-header">
    <div class="page-header-left"><h1>Attendance</h1><p>Employee clock-in/out tracking</p></div>
    <div class="page-header-actions"><button class="btn btn-primary" @onclick="() => showModal = true"><i class="fa fa-plus"></i> Record Attendance</button></div>
</div>

<DataGrid TItem="Attendance" Items="items" Title="Attendance Records" IsLoading="isLoading">
    <HeaderTemplate><th>Employee</th><th>Date</th><th>Clock In</th><th>Clock Out</th><th>Status</th><th>Location</th></HeaderTemplate>
    <RowTemplate Context="item">
        <td><strong>@item.EmployeeName</strong></td>
        <td>@item.Date.ToString("MMM dd, yyyy")</td>
        <td>@(item.ClockIn?.ToString(@"hh\:mm") ?? "—")</td>
        <td>@(item.ClockOut?.ToString(@"hh\:mm") ?? "—")</td>
        <td><span class="badge @(item.Status == "Present" ? "badge-success" : item.Status == "Late" ? "badge-warning" : "badge-danger")">@item.Status</span></td>
        <td>@item.GeoLocation</td>
    </RowTemplate>
</DataGrid>

<ModalDialog @bind-IsVisible="showModal" Title="Record Attendance">
    <EditForm Model="newItem" OnValidSubmit="Save">
        <div class="form-group"><label class="form-label">Employee Name</label><InputText @bind-Value="newItem.EmployeeName" class="form-control" /></div>
        <div class="form-group"><label class="form-label">Date</label><InputDate @bind-Value="newItem.Date" class="form-control" /></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Clock In</label><InputText @bind-Value="clockInStr" class="form-control" placeholder="09:00" /></div>
            <div class="form-group"><label class="form-label">Clock Out</label><InputText @bind-Value="clockOutStr" class="form-control" placeholder="17:00" /></div>
        </div>
        <div class="form-group"><label class="form-label">Status</label>
            <InputSelect @bind-Value="newItem.Status" class="form-control"><option>Present</option><option>Late</option><option>Absent</option></InputSelect>
        </div>
        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Save</button>
    </EditForm>
</ModalDialog>

@code {
    private List<Attendance> items = new(); private bool isLoading = true; private bool showModal;
    private Attendance newItem = new() { Date = DateTime.Today, Status = "Present" };
    private string clockInStr = "09:00"; private string clockOutStr = "17:00";
    protected override async Task OnInitializedAsync() => await LoadData();
    private async Task LoadData() { isLoading = true; items = await EmployeeService.GetAttendanceAsync(); isLoading = false; }
    private async Task Save()
    {
        if (TimeSpan.TryParse(clockInStr, out var ci)) newItem.ClockIn = ci;
        if (TimeSpan.TryParse(clockOutStr, out var co)) newItem.ClockOut = co;
        await EmployeeService.CreateAttendanceAsync(newItem);
        newItem = new() { Date = DateTime.Today, Status = "Present" }; showModal = false; await LoadData();
    }
}
