@page "/attendance/list"
@using QMCH.Models
@using Microsoft.AspNetCore.Components.Forms
@rendermode InteractiveServer

<PageTitle>Attendance - QHMCPro</PageTitle>

<div class="attendance-page">
    <div class="page-header">
        <div class="page-header-left">
            <h1>MANAGE ATTENDANCE</h1>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-new" @onclick="() => showNewModal = true"><i class="fa fa-plus"></i> New</button>
            <button class="btn btn-search" @onclick="() => showSearchModal = true"><i class="fa fa-search"></i> Search</button>
            <button class="btn btn-clear" @onclick="ClearFilters"><i class="fa fa-times"></i> Clear</button>
        </div>
    </div>

    <div class="content-area">
        <div class="main-panel">
            <DataGrid TItem="Attendance" Items="items" Title="Attendance Records" IsLoading="isLoading" ShowSearch="false">
                <HeaderTemplate>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Job title</th>
                    <th>Punch Date</th>
                    <th>Punch Time</th>
                    <th>In/Out</th>
                    <th>Device Name</th>
                    <th>Plate No</th>
                    <th></th>
                </HeaderTemplate>
                <RowTemplate Context="item">
                    <td>@(item.EmployeeId?.ToString() ?? "—")</td>
                    <td>@item.EmployeeName</td>
                    <td>@(item.Status ?? "—")</td>
                    <td>@item.Date.ToString("yyyy-MM-dd")</td>
                    <td>@(item.ClockIn?.ToString(@"hh\:mm") ?? "—")</td>
                    <td>@(item.ClockOut.HasValue ? "OUT" : "IN")</td>
                    <td>@item.GeoLocation</td>
                    <td></td>
                    <td><button class="btn btn-sm btn-edit" title="Edit"><i class="fa fa-edit"></i></button></td>
                </RowTemplate>
            </DataGrid>
        </div>

        <div class="side-panel">
            <div class="filter-box">
                <h4>Filter</h4>
                <label>Business Unit</label>
                <select class="form-control" @bind="filterBusinessUnit">
                    <option value="">--Select--</option>
                </select>
                <label>Department</label>
                <select class="form-control" @bind="filterDepartment">
                    <option value="">--Select Business Unit--</option>
                </select>
                <label>Job Title</label>
                <select class="form-control" @bind="filterJobTitle">
                    <option value="">--Select--</option>
                </select>
                <label>From Date</label>
                <InputDate @bind-Value="searchFromDate" class="form-control" />
                <label>To Date</label>
                <InputDate @bind-Value="searchToDate" class="form-control" />
            </div>
        </div>
    </div>

    <ModalDialog @bind-IsVisible="showNewModal" Title="Mark Attendance (Manual)" Size="lg">
        <EditForm Model="newItem" OnValidSubmit="Save">
            <div class="form-grid">
                <div class="form-group">
                    <label>Employee</label>
                    <InputSelect @bind-Value="newItem.EmployeeId" class="form-control">
                        <option value="">--Select--</option>
                        @foreach (var emp in employees)
                        {
                            <option value="@emp.Id">@emp.FirstName @emp.LastName</option>
                        }
                    </InputSelect>
                </div>
                <div class="form-group"><label>Punch Date</label><InputDate @bind-Value="newItem.Date" class="form-control" /></div>
                <div class="form-group"><label>Punch Time</label>
                    <input type="time" value="@clockInStr" @onchange="@(e => clockInStr = e?.Value?.ToString() ?? string.Empty)" class="form-control" />
                </div>
                <div class="form-group"><label>Type</label>
                    <InputRadioGroup TValue="string" @bind-Value="newItem.Status">
                        <div>
                            <label><InputRadio TValue="string" Value="@("IN")" /> IN</label>
                            <label style="margin-left:12px"><InputRadio TValue="string" Value="@("OUT")" /> OUT</label>
                        </div>
                    </InputRadioGroup>
                </div>
            </div>

            <div class="form-group"><label>Remark</label><InputTextArea @bind-Value="newItem.Notes" class="form-control" /></div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-save" disabled="@isSaving">Save</button>
                <button type="button" class="btn btn-cancel" @onclick="() => showNewModal = false">Cancel</button>
            </div>
        </EditForm>
    </ModalDialog>

    <ModalDialog @bind-IsVisible="showSearchModal" Title="Filter / Search" Size="lg">
        <div class="form-grid">
            <div class="form-group"><label>From Date</label><InputDate @bind-Value="searchFromDate" class="form-control" /></div>
            <div class="form-group"><label>To Date</label><InputDate @bind-Value="searchToDate" class="form-control" /></div>
            <div class="form-group"><label>Employee</label>
                <InputSelect @bind-Value="searchEmployeeId" class="form-control">
                    <option value="">(All Employees)</option>
                    @foreach (var emp in employees)
                    {
                        <option value="@emp.Id">@emp.FirstName @emp.LastName</option>
                    }
                </InputSelect>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-search" @onclick="ApplySearchFromModal">Filter</button>
            <button class="btn btn-clear" @onclick="() => showSearchModal = false">Close</button>
        </div>
    </ModalDialog>
</div>
