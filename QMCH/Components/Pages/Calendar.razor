@page "/schedule/calendar"
@inject IScheduleService ScheduleService
@inject IEmployeeService EmployeeService
@inject IClientService ClientService
@rendermode InteractiveServer

<PageTitle>Schedule Calendar - Quality Homecare System</PageTitle>

<div class="calendar-page-container">
    <!-- Header -->
    <div class="calendar-page-header">
        <div class="header-left">
            <h1>SCHEDULE CALENDAR</h1>
        </div>
        <div class="header-right">
            <span class="schedule-link">Schedule / Calendar</span>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-section">
            <button class="btn btn-add-schedule" @onclick="OpenAddScheduleModal">
                <i class="fa fa-plus"></i> Add Schedule
            </button>
            <button class="btn btn-mass-update" @onclick="OpenMassUpdateModal">
                <i class="fa fa-edit"></i> Mass Update
            </button>
            <button class="btn btn-duty-interruption" @onclick="OpenDutyInterruptionModal">
                <i class="fa fa-warning"></i> Duty Interruption
            </button>
            <button class="btn btn-confirm" @onclick="OpenConfirmModal">
                <i class="fa fa-check"></i> Confirm
            </button>
            <button class="btn btn-filter" @onclick="RefreshCalendar">
                <i class="fa fa-refresh"></i> Filter/Refresh
            </button>
        </div>

        <div class="filter-controls">
            <select @bind="selectedClassification" @bind:event="onchange" class="form-control filter-select">
                <option value="">Filter by Client</option>
                @foreach (var c in allClients)
                {
                    <option value="@c.Id">@(c.FirstName + " " + c.LastName)</option>
                }
            </select>
            <select @bind="selectedServiceType" @bind:event="onchange" class="form-control filter-select">
                <option value="">All Services</option>
                <option value="Shift">Shift</option>
                <option value="Visit">Visit</option>
                <option value="Training">Training</option>
            </select>
            <select @bind="selectedNurse" @bind:event="onchange" class="form-control filter-select">
                <option value="">All Nurses</option>
                @foreach (var n in allNurses)
                {
                    <option value="@n.Id">@(n.FirstName + " " + n.LastName)</option>
                }
            </select>
            <button class="btn btn-clear-filters" @onclick="ClearFilters">
                <i class="fa fa-times"></i> Clear Filters
            </button>
        </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="calendar-nav-bar">
        <div class="nav-left">
            <button class="nav-btn" @onclick="PrevMonth"><i class="fa fa-chevron-left"></i></button>
            <button class="nav-btn" @onclick="GoToToday">Today</button>
            <button class="nav-btn" @onclick="NextMonth"><i class="fa fa-chevron-right"></i></button>
        </div>
        <h2 class="calendar-month-year">@currentDate.ToString("MMMM yyyy")</h2>
        <div class="nav-right">
            <span>Schedule / Calendar</span>
        </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-wrapper">
        <div class="calendar-container">
            <!-- Day Headers -->
            <div class="calendar-header-row">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            </div>

            <!-- Calendar Days -->
            <div class="calendar-grid">
                @foreach (var day in calendarDays)
                {
                    var dayEvents = GetEventsForDay(day.Date);
                    <div class="calendar-cell @(day.IsCurrentMonth ? "" : "other-month") @(day.Date == DateTime.Today ? "today" : "") @(day.Date.DayOfWeek == DayOfWeek.Saturday || day.Date.DayOfWeek == DayOfWeek.Sunday ? "weekend" : "")">
                        <div class="cell-date">@day.Date.Day</div>
                        <div class="cell-events">
                            @foreach (var evt in dayEvents.Take(2))
                            {
                                <div class="event-badge @evt.ColorClass" title="@evt.Title">
                                    <span>@evt.Title</span>
                                </div>
                            }
                            @if (dayEvents.Count > 2)
                            {
                                <div class="event-more">+@(dayEvents.Count - 2) more</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="calendar-legend">
        <div class="legend-item">
            <span class="legend-color planning-schedule"></span>
            <span>Planning Schedule</span>
        </div>
        <div class="legend-item">
            <span class="legend-color actual-schedule"></span>
            <span>Actual Schedule</span>
        </div>
        <div class="legend-item">
            <span class="legend-color daily-interruption"></span>
            <span>Daily Interruption</span>
        </div>
        <div class="legend-item">
            <span class="legend-color device-interruption"></span>
            <span>Device Interruption</span>
        </div>
        <div class="legend-item">
            <span class="legend-color leave"></span>
            <span>Leave</span>
        </div>
        <div class="legend-item">
            <span class="legend-color appointment"></span>
            <span>Appointment</span>
        </div>
        <div class="legend-item">
            <span class="legend-color change-occurred"></span>
            <span>Change Occurred</span>
        </div>
        <div class="legend-item">
            <span class="legend-color reliever"></span>
            <span>Reliever</span>
        </div>
    </div>
</div>

<!-- Add Schedule Modal -->
<ModalDialog @bind-IsVisible="showAddScheduleModal" Title="Add Schedule" Size="lg" CloseOnOverlay="false">
    <div class="modal-form">
        <div class="form-section">
            <h4>Client Information</h4>
            <div class="form-group">
                <label>Client <span class="required">*</span></label>
                <select @bind="newSchedule.ClientName" class="form-control">
                    <option value="">--Select--</option>
                    @foreach (var c in allClients)
                    {
                        <option value="@(c.FirstName + " " + c.LastName)">@(c.FirstName + " " + c.LastName)</option>
                    }
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Service Order</label>
                    <select class="form-control">
                        <option>--Select--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Street</label>
                    <input type="text" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Area</label>
                    <select class="form-control">
                        <option>--Select--</option>
                    </select>
                </div>
            </div>

            <button type="button" class="btn btn-pin-location">?? Pin Location</button>
        </div>

        <div class="form-section">
            <h4>Booking Information</h4>
            <div class="form-group">
                <label>Nurse <span class="required">*</span></label>
                <select @bind="newSchedule.EmployeeName" class="form-control">
                    <option value="">--Select--</option>
                    @foreach (var n in allNurses)
                    {
                        <option value="@(n.FirstName + " " + n.LastName)">@(n.FirstName + " " + n.LastName)</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Day Frequency</label>
                <div class="days-checkbox">
                    <label><input type="checkbox" @bind="selectedDays[0]" /> Su</label>
                    <label><input type="checkbox" @bind="selectedDays[1]" /> Mo</label>
                    <label><input type="checkbox" @bind="selectedDays[2]" /> Tu</label>
                    <label><input type="checkbox" @bind="selectedDays[3]" /> We</label>
                    <label><input type="checkbox" @bind="selectedDays[4]" /> Th</label>
                    <label><input type="checkbox" @bind="selectedDays[5]" /> Fr</label>
                    <label><input type="checkbox" @bind="selectedDays[6]" /> Sa</label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <InputDate @bind-Value="newSchedule.StartDate" class="form-control" />
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <InputDate @bind-Value="newSchedule.EndDate" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="time" @onchange="@((ChangeEventArgs e) => { scheduleStartTime = e.Value?.ToString() ?? scheduleStartTime; })" value="@scheduleStartTime" class="form-control" />
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="time" @onchange="@((ChangeEventArgs e) => { scheduleEndTime = e.Value?.ToString() ?? scheduleEndTime; })" value="@scheduleEndTime" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Odd Days <input type="checkbox" class="checkbox-inline" /></label>
                </div>
                <div class="form-group">
                    <label>Even Days <input type="checkbox" class="checkbox-inline" /></label>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>Office reason for adding extra hours (not Planning)</h4>
            <textarea class="form-control" rows="3" @bind="newSchedule.Notes" placeholder="Enter reason..."></textarea>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-save" @onclick="SaveAddSchedule">Save</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseAddScheduleModal">Cancel</button>
        </div>
    </div>
</ModalDialog>

<!-- Mass Update Modal -->
<ModalDialog @bind-IsVisible="showMassUpdateModal" Title="Mass Update Actual (Schedule)" Size="lg" CloseOnOverlay="false">
    <div class="modal-form">
        <div class="form-section">
            <h4>Mass Update Options</h4>
            
            <div class="form-group">
                <label>Client <span class="required">*</span></label>
                <select @bind="massUpdateClient" class="form-control">
                    <option value="">--Select--</option>
                    @foreach (var c in allClients)
                    {
                        <option value="@(c.FirstName + " " + c.LastName)">@(c.FirstName + " " + c.LastName)</option>
                    }
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Service Order / Medical Record #</label>
                    <select @bind="massUpdateServiceOrder" class="form-control">
                        <option value="">--Select--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Period</label>
                    <select @bind="massUpdatePeriod" class="form-control">
                        <option value="">--Select--</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Days</label>
                <div class="days-checkbox">
                    <label><input type="checkbox" @bind="massUpdateDays[0]" /> Su</label>
                    <label><input type="checkbox" @bind="massUpdateDays[1]" /> Mo</label>
                    <label><input type="checkbox" @bind="massUpdateDays[2]" /> Tu</label>
                    <label><input type="checkbox" @bind="massUpdateDays[3]" /> We</label>
                    <label><input type="checkbox" @bind="massUpdateDays[4]" /> Th</label>
                    <label><input type="checkbox" @bind="massUpdateDays[5]" /> Fr</label>
                    <label><input type="checkbox" @bind="massUpdateDays[6]" /> Sa</label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <InputDate @bind-Value="massUpdateStartDate" class="form-control" />
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <InputDate @bind-Value="massUpdateEndDate" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Include Odd Days <input type="checkbox" @bind="massUpdateIncludeOddDays" class="checkbox-inline" /></label>
                </div>
                <div class="form-group">
                    <label>Include Even Days <input type="checkbox" @bind="massUpdateIncludeEvenDays" class="checkbox-inline" /></label>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-update" @onclick="PerformMassUpdate">Calculate Dates/Times</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseMassUpdateModal">Cancel</button>
        </div>
    </div>
</ModalDialog>

<!-- Duty Interruption Modal -->
<ModalDialog @bind-IsVisible="showDutyInterruptionModal" Title="Duty Interruption" Size="lg" CloseOnOverlay="false">
    <div class="modal-form">
        <div class="form-section">
            <p class="info-text">This field can be used to create a Duty Interruption for nurses, that means the nurse cannot be scheduled to any client on the selected day(s).</p>

            <div class="form-group">
                <label>Nurse <span class="required">*</span></label>
                <select @bind="dutyInterruptionNurse" class="form-control">
                    <option value="">--Select--</option>
                    @foreach (var n in allNurses)
                    {
                        <option value="@(n.FirstName + " " + n.LastName)">@(n.FirstName + " " + n.LastName)</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Days</label>
                <div class="days-checkbox">
                    <label><input type="checkbox" @bind="dutyInterruptionDays[0]" /> Su</label>
                    <label><input type="checkbox" @bind="dutyInterruptionDays[1]" /> Mo</label>
                    <label><input type="checkbox" @bind="dutyInterruptionDays[2]" /> Tu</label>
                    <label><input type="checkbox" @bind="dutyInterruptionDays[3]" /> We</label>
                    <label><input type="checkbox" @bind="dutyInterruptionDays[4]" /> Th</label>
                    <label><input type="checkbox" @bind="dutyInterruptionDays[5]" /> Fr</label>
                    <label><input type="checkbox" @bind="dutyInterruptionDays[6]" /> Sa</label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <InputDate @bind-Value="dutyInterruptionStartDate" class="form-control" />
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <InputDate @bind-Value="dutyInterruptionEndDate" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Include Odd Days <input type="checkbox" @bind="includeOddDays" class="checkbox-inline" /></label>
                </div>
                <div class="form-group">
                    <label>Include Even Days <input type="checkbox" @bind="includeEvenDays" class="checkbox-inline" /></label>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-search" @onclick="SearchSchedule">?? Search Schedule</button>
            <button type="button" class="btn btn-save" @onclick="SaveDutyInterruption">Save</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseDutyInterruptionModal">Cancel</button>
        </div>
    </div>
</ModalDialog>

<!-- Schedule Confirm Modal -->
<ModalDialog @bind-IsVisible="showConfirmModal" Title="Schedule Confirm" Size="lg" CloseOnOverlay="false">
    <div class="modal-form">
        <div class="confirm-header">
            <div class="confirm-nav">
                <button class="nav-btn" @onclick="PrevConfirmMonth"><i class="fa fa-chevron-left"></i></button>
                <button class="nav-btn" @onclick="GoToTodayConfirm">Today</button>
                <button class="nav-btn" @onclick="NextConfirmMonth"><i class="fa fa-chevron-right"></i></button>
            </div>
            <h3 class="confirm-month-year">@confirmViewDate.ToString("MMMM yyyy")</h3>
            <div class="confirm-info">Today</div>
        </div>

        <div class="confirm-table-wrapper">
            <table class="confirm-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Confirmed</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var schedule in GetConfirmableSchedules())
                    {
                        <tr>
                            <td>@schedule.StartDate.ToString("HH:mm")<br />@schedule.StartDate.ToString("yyyy")</td>
                            <td>
                                <input type="checkbox" @bind="confirmedSchedules[schedule.Id]" class="confirm-checkbox" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-save" @onclick="SaveConfirmations">Save Confirmations</button>
            <button type="button" class="btn btn-cancel" @onclick="CloseConfirmModal">Cancel</button>
        </div>
    </div>
</ModalDialog>
