@namespace QMCH.Components.Shared

<div class="input-group">
    <label for="@Id" class="form-label">
        @Label 
        @if (Required)
        {
            <span class="required-indicator" aria-label="required">*</span>
        }
    </label>
    @if (Type == "select")
    {
        <select id="@Id" class="form-control @(HasError ? "is-invalid" : "")" 
                @bind="Value" @bind:event="onchange" disabled="@Disabled">
            <option value="">-- Select --</option>
            @if (Options != null)
            {
                @foreach (var option in Options)
                {
                    <option value="@option.Key">@option.Value</option>
                }
            }
        </select>
    }
    else if (Type == "textarea")
    {
        <textarea id="@Id" class="form-control @(HasError ? "is-invalid" : "")" 
                  rows="@TextAreaRows" placeholder="@Placeholder"
                  @bind="Value" @bind:event="onchange" disabled="@Disabled"></textarea>
    }
    else if (Type == "checkbox")
    {
        <input type="checkbox" id="@Id" class="form-check-input @(HasError ? "is-invalid" : "")" 
               @bind="CheckedValue" disabled="@Disabled" />
    }
    else if (Type == "date")
    {
        <input type="date" id="@Id" class="form-control @(HasError ? "is-invalid" : "")" 
               value="@Value" @onchange="@((ChangeEventArgs e) => OnDateChanged(e.Value?.ToString() ?? ""))" disabled="@Disabled" />
    }
    else if (Type == "number")
    {
        <input type="number" id="@Id" class="form-control @(HasError ? "is-invalid" : "")" 
               placeholder="@Placeholder" value="@NumberValue" @onchange="@((ChangeEventArgs e) => OnNumberChanged(e.Value))" disabled="@Disabled" />
    }
    else
    {
        <input type="@Type" id="@Id" class="form-control @(HasError ? "is-invalid" : "")" 
               placeholder="@Placeholder" @bind="Value" disabled="@Disabled" />
    }
    
    @if (HasError && !string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="invalid-feedback d-block">
            @ErrorMessage
        </div>
    }
    
    @if (!string.IsNullOrEmpty(HelpText))
    {
        <small class="form-text text-muted">@HelpText</small>
    }
</div>

@code {
    [Parameter]
    public string Id { get; set; } = Guid.NewGuid().ToString();

    [Parameter]
    public string Label { get; set; } = "";

    [Parameter]
    public string Type { get; set; } = "text";

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    [Parameter]
    public decimal NumberValue { get; set; }

    [Parameter]
    public EventCallback<decimal> NumberValueChanged { get; set; }

    [Parameter]
    public bool CheckedValue { get; set; }

    [Parameter]
    public EventCallback<bool> CheckedValueChanged { get; set; }

    [Parameter]
    public string Placeholder { get; set; } = "";

    [Parameter]
    public bool Required { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public Dictionary<string, string>? Options { get; set; }

    [Parameter]
    public string ErrorMessage { get; set; } = "";

    [Parameter]
    public bool HasError { get; set; }

    [Parameter]
    public string HelpText { get; set; } = "";

    [Parameter]
    public int TextAreaRows { get; set; } = 4;

    private async Task OnDateChanged(string newValue)
    {
        Value = newValue;
        await ValueChanged.InvokeAsync(newValue);
    }

    private async Task OnNumberChanged(object? newValue)
    {
        if (newValue != null && decimal.TryParse(newValue.ToString(), out var decValue))
        {
            NumberValue = decValue;
            await NumberValueChanged.InvokeAsync(decValue);
        }
    }
}
